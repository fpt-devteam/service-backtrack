version: '3.8'

services:
  # API Gateway - Single entry point for all client requests
  api-gateway:
    build:
      context: .
      dockerfile: Backtrack.ApiGateway/Dockerfile
    container_name: backtrack-gateway
    ports:
      - "5000:5000"
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - Firebase__ProjectId=${FIREBASE_PROJECT_ID}
      - Firebase__ServiceAccountPath=/app/firebase-credentials.json
      - Firebase__ForwardAuthHeader=false
    volumes:
      # Mount Firebase service account (DO NOT commit this file!)
      - ./firebase-service-account.json:/app/firebase-credentials.json:ro
    networks:
      - backtrack-network
    depends_on:
      - backtrack-core
      - backtrack-chat
      - backtrack-notifications
    restart: unless-stopped

  # BackTrack Core Service - Posts, Search, Matching
  backtrack-core:
    image: backtrack-core:latest
    container_name: backtrack-core
    ports:
      - "8080:8080"
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ConnectionStrings__DefaultConnection=${CORE_DB_CONNECTION}
    networks:
      - backtrack-network
    restart: unless-stopped
    # Uncomment if you want to build locally instead of using pre-built image
    # build:
    #   context: .
    #   dockerfile: BackTrack.Core/Dockerfile

    # BackTrack Chat Service - Real-time messaging
  backtrack-chat:
    image: backtrack-chat:latest
    container_name: backtrack-chat
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
      - MONGODB_URI=${CHAT_DB_CONNECTION}
    networks:
      - backtrack-network
    restart: unless-stopped
    # Uncomment if you want to build locally
    # build:
    #   context: ./BackTrack.Chat
    #   dockerfile: Dockerfile

    # BackTrack Notifications Service - Push notifications
  backtrack-notifications:
    image: backtrack-notifications:latest
    container_name: backtrack-notifications
    ports:
      - "7000:7000"
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ConnectionStrings__DefaultConnection=${NOTIFY_DB_CONNECTION}
      - Firebase__ProjectId=${FIREBASE_PROJECT_ID}
    networks:
      - backtrack-network
    restart: unless-stopped
    # Uncomment if you want to build locally
    # build:
    #   context: .
    #   dockerfile: BackTrack.Notifications/Dockerfile

  backtrack-core-db:
    image: postgres:16-alpine
    container_name: backtrack-core-db
    hostname: backtrack-core-db
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_DB=backtrack-core-db
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres123
    volumes:
      - backtrack-core-db-data:/var/lib/postgresql/backtrack-core-db-data
    networks:
      - backtrack-network

  # Qdrant Vector Database - For semantic search and item matching
  backtrack-core-vector-db:
    image: qdrant/qdrant:latest
    container_name: backtrack-core-vector-db
    hostname: backtrack-core-vector-db
    ports:
      - "6333:6333" # HTTP API
      - "6334:6334" # gRPC API
    environment:
      - QDRANT__SERVICE__HTTP_PORT=6333
      - QDRANT__SERVICE__GRPC_PORT=6334
    volumes:
      - backtrack-core-vector-db-data:/qdrant/storage
    networks:
      - backtrack-network
    restart: unless-stopped

networks:
  backtrack-network:
    driver: bridge

volumes:
  backtrack-core-db-data:
  backtrack-core-vector-db-data:
