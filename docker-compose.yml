version: '3.8'

services:
  # API Gateway - Single entry point for all client requests
  backtrack-api-gateway:
    build:
      context: .
      dockerfile: dockerfiles/Dockerfile.backtrack-api-gateway
    container_name: backtrack-api-gateway
    ports:
      - "5000:5000"
    env_file:
      - ./env/backtrack-api-gateway.docker.env
    volumes:
      - C:\Users\NHATTHANG\FptUniversity\SEP490\backtrack-sep490-firebase-adminsdk-fbsvc-d625f3f3d9.json:/secret/firebase-credentials.json:ro
    networks:
      - backtrack-network
    depends_on:
      - backtrack-core-api
    #   - backtrack-chat
    #   - backtrack-notifications
    restart: unless-stopped

  # BackTrack Core Service - Posts, Search, Matching
  backtrack-core-api:
    build:
      context: .
      dockerfile: dockerfiles/Dockerfile.backtrack-core-api
    container_name: backtrack-core-api
    ports:
      - "8080:8080"
    env_file:
      - ./env/backtrack-core-api.docker.env
    networks:
      - backtrack-network
    restart: unless-stopped

  backtrack-core-db:
    image: postgis/postgis:16-3.4
    container_name: backtrack-core-db
    hostname: backtrack-core-db
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_DB=backtrack-core-db
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres123
    volumes:
      - backtrack-core-db-data:/var/lib/postgresql/backtrack-core-db-data
    networks:
      - backtrack-network

  # Qdrant Vector Database - For semantic search and item matching
  backtrack-core-vector-db:
    image: qdrant/qdrant:latest
    container_name: backtrack-core-vector-db
    hostname: backtrack-core-vector-db
    ports:
      - "6333:6333" # HTTP API
      - "6334:6334" # gRPC API
    environment:
      - QDRANT__SERVICE__HTTP_PORT=6333
      - QDRANT__SERVICE__GRPC_PORT=6334
    volumes:
      - backtrack-core-vector-db-data:/qdrant/storage
    networks:
      - backtrack-network
    restart: unless-stopped

networks:
  backtrack-network:
    driver: bridge

volumes:
  backtrack-core-db-data:
  backtrack-core-vector-db-data:
