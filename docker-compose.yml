version: '3.8'

services:
  # API Gateway - Single entry point for all client requests
  backtrack-api-gateway:
    build:
      context: .
      dockerfile: dockerfiles/Dockerfile.backtrack-api-gateway
    container_name: backtrack-api-gateway
    ports:
      - "5000:5000"
    env_file:
      - ./env/backtrack-api-gateway.docker.env
    volumes:
      - C:\Users\NHATTHANG\FptUniversity\SEP490\backtrack-sep490-firebase-adminsdk-fbsvc-d625f3f3d9.json:/secret/firebase-credentials.json:ro
    networks:
      - backtrack-network
    depends_on:
      - backtrack-core-api
      - backtrack-chat-api
    #   - backtrack-notifications
    restart: unless-stopped

  # BackTrack Core Service - Posts, Search, Matching
  backtrack-core-api:
    build:
      context: .
      dockerfile: dockerfiles/Dockerfile.backtrack-core-api
    container_name: backtrack-core-api
    ports:
      - "8080:8080"
    env_file:
      - ./env/backtrack-core-api.docker.env
    networks:
      - backtrack-network
    restart: unless-stopped

  # BackTrack Chat Service - Real-time messaging
  backtrack-chat-api:
    build:
      context: .
      dockerfile: dockerfiles/Dockerfile.backtrack-chat
    container_name: backtrack-chat-api
    ports:
      - "3000:3000"
    env_file:
      - ./env/backtrack-chat.docker.env
    networks:
      - backtrack-network
    depends_on:
      - backtrack-chat-db
    restart: unless-stopped

  backtrack-core-db:
    build:
      context: .
      dockerfile: dockerfiles/Dockerfile.postgres-postgis-pgvector
    container_name: backtrack-core-db
    hostname: backtrack-core-db
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_DB=backtrack-core-db
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres123
    volumes:
      - backtrack-core-db-data:/var/lib/postgresql/data
    networks:
      - backtrack-network

  backtrack-chat-db:
    image: mongo:7-jammy
    container_name: backtrack-chat-db
    hostname: backtrack-chat-db
    ports:
      - "27017:27017"
    environment:
      - MONGO_INITDB_DATABASE=backtrack-chat
    volumes:
      - backtrack-chat-db-data:/data/db
    networks:
      - backtrack-network
    restart: unless-stopped

networks:
  backtrack-network:
    driver: bridge

volumes:
  backtrack-core-db-data:
  backtrack-chat-db-data:

